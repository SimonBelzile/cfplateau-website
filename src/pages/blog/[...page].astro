---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const PAGE_SIZE = 9;

// Génère /blog/1, /blog/2, ...
export async function getStaticPaths() {
  const all = (await getCollection("blog", ({ data }) => !data.draft))
    .sort((a, b) => +new Date(b.data.pubDate) - +new Date(a.data.pubDate));

  const lastPage = Math.max(1, Math.ceil(all.length / 9));

  return Array.from({ length: lastPage }, (_, i) => {
    const current = i + 1;
    const start = (current - 1) * 9;
    const pagePosts = all.slice(start, start + 9);

    return {
      // ✅ catch-all: string, PAS un tableau
      params: { page: String(current) },
      // ✅ on passe tout dans props, rien à recalculer au rendu
      props: { current, lastPage, pagePosts },
    };
  });
}

// ✅ on récupère uniquement ce qu'on a passé
const { current, lastPage, pagePosts } = Astro.props as {
  current: number;
  lastPage: number;
  pagePosts: any[];
};
---
<BaseLayout title="Blog — Abattoir CrossFit Plateau" description="Conseils entraînement, nutrition, et coulisses du gym.">
  <section class="max-w-6xl mx-auto">
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight">Blog</h1>
      <p class="text-white/70 mt-2">Conseils d’entraînement, nutrition, et coulisses du gym.</p>
    </header>

    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {pagePosts.map((p) => (
        <article class="rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition">
          <a href={`/blog/${p.slug}/`} class="block">
            {p.data.heroImage ? (
              <img src={p.data.heroImage} alt="" loading="lazy" class="w-full aspect-[13/9] object-cover rounded-t-2xl" />
            ) : (
              <div class="w-full aspect-[13/9] rounded-t-2xl bg-gradient-to-br from-black to-white/10" />
            )}
          </a>
          <div class="p-4">
            <h3 class="text-lg font-semibold leading-snug">
              <a class="text-white hover:opacity-80" href={`/blog/${p.slug}/`}>{p.data.title}</a>
            </h3>
            {p.data.description && <p class="mt-2 text-sm text-white/70">{p.data.description}</p>}
            <p class="mt-3 text-xs text-white/50">{p.data.pubDate.toLocaleDateString('fr-CA')}</p>
            {p.data.tags?.length > 0 && (
              <div class="mt-3 flex flex-wrap gap-2">
                {p.data.tags.map((t) => (
                  <a href={`/tag/${encodeURIComponent(t)}/`} class="rounded-full border px-3 py-1 text-xs" style="border-color:#ddb669; color:#ddb669">
                    #{t}
                  </a>
                ))}
              </div>
            )}
          </div>
        </article>
      ))}
    </div>

    <nav class="flex items-center justify-center gap-3 mt-10">
      {current > 1 ? (
        <a href={current - 1 === 1 ? "/blog/" : `/blog/${current - 1}/`} class="btn-ghost">← Précédent</a>
      ) : (
        <span class="btn-ghost opacity-40 pointer-events-none">← Précédent</span>
      )}
      <span class="text-white/70 text-sm">Page {current} / {lastPage}</span>
      {current < lastPage ? (
        <a href={`/blog/${current + 1}/`} class="btn-primary">Suivant →</a>
      ) : (
        <span class="btn-primary opacity-40 pointer-events-none">Suivant →</span>
      )}
    </nav>
  </section>
</BaseLayout>
