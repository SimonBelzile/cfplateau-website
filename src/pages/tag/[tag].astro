---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

// Génère /tag/<tag> pour chaque tag présent dans les posts publiés
export async function getStaticPaths() {
  const all = await getCollection("blog", ({ data }) => !data.draft);

  // liste unique de tags (stringifiés pour éviter les surprises)
  const tags = Array.from(
    new Set(
      all.flatMap((p) => (p.data.tags ?? []).map((t) => String(t)))
    )
  );

  return tags.map((t) => ({
    params: { tag: t }, // <-- string simple
    props: {
      tag: t,
      posts: all
        .filter((p) => (p.data.tags ?? []).map(String).includes(t))
        .sort((a, b) => +new Date(b.data.pubDate) - +new Date(a.data.pubDate)),
    },
  }));
}

const { tag, posts } = Astro.props as { tag: string; posts: any[] };
---
<BaseLayout title={`#${tag} — Abattoir CrossFit Plateau`}>
  <section class="max-w-6xl mx-auto">
    <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight mb-6">#{tag}</h1>

    {posts.length === 0 ? (
      <p class="text-white/70">Aucun article pour ce tag.</p>
    ) : (
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {posts.map((p) => (
          <article class="rounded-2xl border border-white/10 bg-white/5 hover:bg-white/10 transition">
            <a href={`/blog/${p.slug}/`} class="block">
              {p.data.heroImage ? (
                <img src={p.data.heroImage} alt="" loading="lazy" class="w-full aspect-[13/9] object-cover rounded-t-2xl" />
              ) : (
                <div class="w-full aspect-[13/9] rounded-t-2xl bg-gradient-to-br from-black to-white/10" />
              )}
            </a>
            <div class="p-4">
              <h3 class="text-lg font-semibold leading-snug">
                <a class="text-white hover:opacity-80" href={`/blog/${p.slug}/`}>{p.data.title}</a>
              </h3>
              {p.data.description && <p class="mt-2 text-sm text-white/70">{p.data.description}</p>}
              <p class="mt-3 text-xs text-white/50">{p.data.pubDate.toLocaleDateString('fr-CA')}</p>
            </div>
          </article>
        ))}
      </div>
    )}
  </section>
</BaseLayout>
